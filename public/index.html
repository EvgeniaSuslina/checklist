<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <title>Чек-лист и трекер статусов</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        padding: 20px;
        background: #f4f6f8;
      }

      h2 {
        margin-bottom: 10px;
      }

      button {
        margin: 5px 5px 15px 0;
        padding: 6px 12px;
        cursor: pointer;
      }

      table {
        border-collapse: collapse;
        width: 100%;
        max-width: 1000px;
        background: #fff;
      }

      th,
      td {
        border: 1px solid #bbb;
        padding: 8px;
        text-align: center;
      }

      th {
        background: #e9ecef;
      }

      .editable {
        background: #fff8dc;
      }

      .editable:focus {
        outline: 2px solid #4a90e2;
        background: #fff;
      }

      .left-column {
        text-align: left;
        min-width: 180px;
      }

      .status {
        font-weight: bold;
        min-width: 120px;
      }

      .status.todo {
        color: #999;
      }
      .status.progress {
        color: #e67e22;
      }
      .status.done {
        color: #27ae60;
      }

      input[type="checkbox"] {
        transform: scale(1.2);
      }
    </style>
  </head>
  <body>
    <h2>Чек-лист / Отслеживание статусов</h2>

    <button onclick="addRow()">➕ Добавить строку</button>
    <button onclick="addColumn()">➕ Добавить колонку</button>

    <table id="checklist">
      <thead>
        <tr>
          <th class="editable" contenteditable="true">Задача</th>
          <th class="editable" contenteditable="true">Этап 1</th>
          <th class="editable" contenteditable="true">Этап 2</th>
          <th class="editable" contenteditable="true">Этап 3</th>
          <th>Статус</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td class="editable left-column" contenteditable="true">Задача 1</td>
          <td><input type="checkbox" /></td>
          <td><input type="checkbox" /></td>
          <td><input type="checkbox" /></td>
          <td class="status todo">Не начато</td>
        </tr>
      </tbody>
    </table>

    <script>
      const table = document.getElementById("checklist");

      /* ===== Загрузка ===== */
      async function loadData() {
        const res = await fetch("/api/data");
        const data = await res.json();

        if (!data.table) return;

        const temp = document.createElement("div");
        temp.innerHTML = data.table;

        const newThead = temp.querySelector("thead");
        const newTbody = temp.querySelector("tbody");

        if (newThead && newTbody) {
          table.replaceChild(newThead, table.tHead);
          table.replaceChild(newTbody, table.tBodies[0]);
        }

        [...table.tBodies[0].rows].forEach(updateStatus);
      }

      /* ===== Сохранение ===== */
      async function saveData() {
        await fetch("/api/data", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ table: table.innerHTML }),
        });
      }

      /* ===== Статусы ===== */
      function updateStatus(row) {
        const boxes = row.querySelectorAll('input[type="checkbox"]');
        const status = row.querySelector(".status");
        const checked = [...boxes].filter((b) => b.checked).length;

        status.className = "status";

        if (checked === 0) {
          status.textContent = "Не начато";
          status.classList.add("todo");
        } else if (checked === boxes.length) {
          status.textContent = "Завершено";
          status.classList.add("done");
        } else {
          status.textContent = "В работе";
          status.classList.add("progress");
        }
      }

      /* ===== События ===== */
      table.addEventListener("change", (e) => {
        if (e.target.type === "checkbox") {
          updateStatus(e.target.closest("tr"));
          saveData();
        }
      });

      /* ===== Добавление строки ===== */
      function addRow() {
        const body = table.tBodies[0];
        const firstRow = body.rows[0];

        if (!firstRow) return;

        const row = document.createElement("tr");

        let cells = `
    <td class="editable left-column" contenteditable="true">
      Новая задача
    </td>
  `;

        // количество чекбоксов = все ячейки минус задача и статус
        const checkboxCount = firstRow.cells.length - 2;

        for (let i = 0; i < checkboxCount; i++) {
          cells += `<td><input type="checkbox"></td>`;
        }

        cells += `<td class="status todo">Не начато</td>`;

        row.innerHTML = cells;
        body.appendChild(row);

        saveData();
      }

      /* ===== Добавление колонки ===== */
      function addColumn() {
        const headRow = table.tHead.rows[0];

        // добавляем заголовок перед "Статус"
        const th = document.createElement("th");
        th.className = "editable";
        th.contentEditable = "true";
        th.textContent = "Новый этап";

        headRow.insertBefore(th, headRow.lastElementChild);

        // добавляем чекбоксы в строки
        [...table.tBodies[0].rows].forEach((row) => {
          const td = document.createElement("td");
          td.innerHTML = `<input type="checkbox">`;
          row.insertBefore(td, row.lastElementChild);
          updateStatus(row);
        });

        saveData();
      }

      table.addEventListener("input", saveData);

      loadData();
    </script>
  </body>
</html>
