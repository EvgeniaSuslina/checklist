<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <title>–ß–µ–∫-–ª–∏—Å—Ç –∏ —Ç—Ä–µ–∫–µ—Ä —Å—Ç–∞—Ç—É—Å–æ–≤</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        padding: 20px;
        background: #f4f6f8;
      }

      h2 {
        margin-bottom: 10px;
      }

      button {
        margin: 5px 5px 15px 0;
        padding: 6px 12px;
        cursor: pointer;
      }

      table {
        border-collapse: collapse;
        width: 100%;
        max-width: 1000px;
        background: #fff;
      }

      th,
      td {
        border: 1px solid #bbb;
        padding: 8px;
        text-align: center;
      }

      th {
        background: #e9ecef;
      }

      .editable {
        background: #fff8dc;
      }

      .editable:focus {
        outline: 2px solid #4a90e2;
        background: #fff;
      }

      .left-column {
        text-align: left;
        min-width: 180px;
      }

      .status {
        font-weight: bold;
        min-width: 120px;
      }

      .status.todo {
        color: #999;
      }
      .status.progress {
        color: #e67e22;
      }
      .status.done {
        color: #27ae60;
      }

      input[type="checkbox"] {
        transform: scale(1.2);
      }
    </style>
  </head>
  <body>
    <h2>–ß–µ–∫-–ª–∏—Å—Ç / –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–æ–≤</h2>

    <button onclick="addRow()">‚ûï –î–æ–±–∞–≤–∏—Ç—å —Å—Ç—Ä–æ–∫—É</button>
    <button onclick="addColumn()">‚ûï –î–æ–±–∞–≤–∏—Ç—å –∫–æ–ª–æ–Ω–∫—É</button>
    <button onclick="clearStorage()">üóë –°–±—Ä–æ—Å–∏—Ç—å –¥–∞–Ω–Ω—ã–µ</button>

    <table id="checklist">
      <thead>
        <tr>
          <th class="editable" contenteditable="true">–ó–∞–¥–∞—á–∞</th>
          <th class="editable" contenteditable="true">–≠—Ç–∞–ø 1</th>
          <th class="editable" contenteditable="true">–≠—Ç–∞–ø 2</th>
          <th class="editable" contenteditable="true">–≠—Ç–∞–ø 3</th>
          <th>–°—Ç–∞—Ç—É—Å</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td class="editable left-column" contenteditable="true">–ó–∞–¥–∞—á–∞ 1</td>
          <td><input type="checkbox" /></td>
          <td><input type="checkbox" /></td>
          <td><input type="checkbox" /></td>
          <td class="status todo">–ù–µ –Ω–∞—á–∞—Ç–æ</td>
        </tr>
      </tbody>
    </table>

    <script>
      const table = document.getElementById("checklist");

      /* ===== –ó–∞–≥—Ä—É–∑–∫–∞ ===== */
      async function loadData() {
        const res = await fetch("/api/data");
        const data = await res.json();

        if (data.table) {
          table.innerHTML = data.table;
          [...table.tBodies[0].rows].forEach(updateStatus);
        }
      }

      /* ===== –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ ===== */
      async function saveData() {
        await fetch("/api/data", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ table: table.innerHTML }),
        });
      }

      /* ===== –°—Ç–∞—Ç—É—Å—ã ===== */
      function updateStatus(row) {
        const boxes = row.querySelectorAll('input[type="checkbox"]');
        const status = row.querySelector(".status");
        const checked = [...boxes].filter((b) => b.checked).length;

        status.className = "status";

        if (checked === 0) {
          status.textContent = "–ù–µ –Ω–∞—á–∞—Ç–æ";
          status.classList.add("todo");
        } else if (checked === boxes.length) {
          status.textContent = "–ó–∞–≤–µ—Ä—à–µ–Ω–æ";
          status.classList.add("done");
        } else {
          status.textContent = "–í —Ä–∞–±–æ—Ç–µ";
          status.classList.add("progress");
        }
      }

      /* ===== –°–æ–±—ã—Ç–∏—è ===== */
      table.addEventListener("change", (e) => {
        if (e.target.type === "checkbox") {
          updateStatus(e.target.closest("tr"));
          saveData();
        }
      });

      /* ===== –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å—Ç—Ä–æ–∫–∏ ===== */
      function addRow() {
        const colCount = table.tHead.rows[0].cells.length;
        const row = document.createElement("tr");

        row.innerHTML = `
        <td class="editable left-column" contenteditable="true">–ù–æ–≤–∞—è –∑–∞–¥–∞—á–∞</td>
        ${'<td><input type="checkbox"></td>'.repeat(colCount - 2)}
        <td class="status todo">–ù–µ –Ω–∞—á–∞—Ç–æ</td>
    `;

        table.tBodies[0].appendChild(row);
        saveData();
      }

      /* ===== –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∫–æ–ª–æ–Ω–∫–∏ ===== */
      function addColumn() {
        const th = document.createElement("th");
        th.className = "editable";
        th.contentEditable = "true";
        th.textContent = "–ù–æ–≤—ã–π —ç—Ç–∞–ø";

        table.tHead.rows[0].insertBefore(
          th,
          table.tHead.rows[0].lastElementChild
        );

        [...table.tBodies[0].rows].forEach((row) => {
          const cell = document.createElement("td");
          cell.innerHTML = '<input type="checkbox">';
          row.insertBefore(cell, row.lastElementChild);
          updateStatus(row);
        });

        saveData();
      }

      table.addEventListener("input", saveData);

      loadData();
    </script>
  </body>
</html>
